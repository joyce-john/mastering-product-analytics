---
title: "Mastering Product Analytics"
author: "John Joyce"
date: "5/23/2021"
output:
  html_document:
    theme: "cosmo"
    code_folding: hide
---

# Introduction  

This is an analysis of key metrics for a software-as-a-service product. The data is based off a real SaaS product; it has been subsampled and simplified for this task. We'll use *activity.csv* and *registrations.csv* to take look at user **acquisition**, **activity**, and **retention**. We have 21 months of data for this product.   

```{r load libraries and data, warning=FALSE, message=FALSE}
# libraries
library(tidyverse)
library(ggthemes)
library(ggiraph)
library(scales)
library(kableExtra)
library(fable)
library(tsibble)

# load data from semicolon-delimited file
activity <- read_delim("activity.csv", delim = ";")
registrations <- read_delim("registrations.csv", delim = ";")

```  

# Acquisition  

## Global Registrations

Let's start out by examining registrations. We'll count the number of registrations in each month. We'll also calculate year-over-year percentage changes for the eligible months.  

```{r group and count registrations, warning=FALSE, message=FALSE}

# get registration counts grouped by month
registrations_by_month <- 
  registrations %>% 
  group_by(registration_month) %>% 
  count() %>% # get counts
  rename(count_registered = n) %>% 
  mutate(year = ifelse(registration_month %in% 1:12, "Previous Year", "Current Year")) %>% # label the years
  mutate(month_name = ifelse(registration_month %in% 1:12, month.name[registration_month], month.name[registration_month - 12])) %>% 
  group_by(month_name) %>% # convert numbers to month names
  mutate(year_over_year = (count_registered - lag(count_registered, 1)) / lag(count_registered,1)) %>%  # calculate year-over-year change
  ungroup()

# show html table
registrations_by_month %>% 
  kable() %>% 
  kable_styling(c("striped", "hover")) %>% 
  scroll_box(height = "350px")

```  
\  
  
We'll plot this data below. We'll use a bar graph so that it's easy to compare values from one year against another - just hover over a column to highlight identical months. A dotted line separates the first and second years of product data.   

```{r plot registrations by month, warning=FALSE, message=FALSE}

# ggplot of registrations by month
plot_registrations_by_month <-
  registrations_by_month %>% 
  ggplot(aes(x = registration_month, y = count_registered)) +
  geom_col_interactive(fill = "steelblue4",
                       aes(data_id = month_name, 
                           tooltip = paste0(month_name, " of ", year,
                                            "\n",
                                            "\n",
                                            count_registered, " registrations",
                                            ifelse(is.na(year_over_year), 
                                                   "",
                                                   paste0("\n\n", 
                                                          scales::percent(year_over_year, accuracy = 0.01), 
                                                          " YOY change"))))) +
  geom_vline_interactive(xintercept = 12.5, linetype = "dotted", tooltip = "end of year") +
  theme_calc() +
  labs(x = "Month", y = "New Registrations", title = "Registration Growth")

# show plot with highlight on month type when the user hovers
ggiraph(ggobj = plot_registrations_by_month,
        options = list(opts_hover_inv(css = "opacity:0.2;")))



```  
  
  
We notice some low points in **January - Feburary** and **June - July** (possibly including **August**). Our stronger months appear to be **March - May** and **September - November**.  

Based on the data we have, it seems that we acquire the most users in the **spring** and **autumn** seasons, and experience a slump in **winter** and **summer**.  

What would we project for month 22? If we fit an auto ARIMA model with the existing data, we get the forecast shown with the red column below:  

```{r ARIMA registations with plot, warning = FALSE, message = FALSE}

# create tsibble object for use with fable package
registrations_tsibble <- 
as_tsibble(registrations_by_month, index = registration_month)

# fit auto ARIMA model for count of registrations
registrations_fit <-
model(registrations_tsibble,
      arima = ARIMA(count_registered))

# forecast 1 month into the future
registrations_forecast <- forecast(registrations_fit, h = 1)

# create a 1-row dataframe with the stats for the forecast
registrations_forecast_row <- 
data.frame(
  "registration_month" = 22,
  "count_registered" = round(registrations_forecast$.mean, 0),
  "year" = "Current Year",
  "month_name" = "October",
  "year_over_year" = (registrations_forecast$.mean - registrations_by_month$count_registered[10]) / registrations_by_month$count_registered[10])

# bind the forecast row to the original table
registrations_forecast_df <-
  rbind(registrations_by_month, registrations_forecast_row)

# set a factor to differentiate the forecast from the real data
registrations_forecast_df <-
registrations_forecast_df %>% 
  mutate(is_forecast = ifelse(registration_month == 22, TRUE, FALSE))


# ggplot of registrations by month - WITH RED FORECAST BAR
plot_registrations_forecast <-
  registrations_forecast_df %>% 
  ggplot(aes(x = registration_month, y = count_registered)) +
  geom_col_interactive(aes(fill = is_forecast,
                           data_id = month_name, 
                           tooltip = paste0(month_name, " of ", year,
                                            "\n",
                                            "\n",
                                            count_registered, " registrations",
                                            ifelse(is.na(year_over_year), 
                                                   "",
                                                   paste0("\n\n", 
                                                          scales::percent(year_over_year, accuracy = 0.01), 
                                                          " YOY change"))))) +
  geom_vline_interactive(xintercept = 12.5, linetype = "dotted", tooltip = "end of year") +
  theme_calc() +
  scale_fill_manual_interactive(values = c("steelblue4", "tomato")) +
  theme(legend.position = "none") +
  labs(x = "Month", y = "New Registrations", title = "Registration Growth with Forecast")

# show plot with highlight on month type when the user hovers
ggiraph(ggobj = plot_registrations_forecast,
        options = list(opts_hover_inv(css = "opacity:0.2;")))



```  

We might be skeptical of this forecast. It suggests a -22% year-over-year change from last year's October. However, it reflects the significant uncertainty surrounding the user acquisition trend. We would have expected this year's September to be a strong month, because the year-over-year growth was positive for all preceding months. But growth slowed in August and turned negative in September, so we ended up with **fewer** registrations this September than last year. What does that mean for October? Could we be heading for a negative trend?   

Without any additional information, I would hesitantly predict an October performance similar to, or somewhat weaker than, last year's. The catastrophic decline suggested by the auto-ARIMA prediction seems a bit unlikely, and may be due to a lack of historical seasonal data for the model. However, given the poor growth in September, we shouldn't be surprised if we acquire fewer users than last year.    


## Regional Registrations

What are the acquisition trends in different regions?  

```{r create regions acquisition table and plot, warning = FALSE, message = FALSE}

# get registration counts grouped by month AND also by region
registrations_by_month_and_region <- 
  registrations %>% 
  group_by(registration_month, region) %>% 
  count() %>% # get counts
  rename(count_registered = n) %>% 
  mutate(year = ifelse(registration_month %in% 1:12, "Previous Year", "Current Year")) %>% # label the years
  mutate(month_name = ifelse(registration_month %in% 1:12, month.name[registration_month], month.name[registration_month - 12])) %>% 
  group_by(month_name, region) %>% # convert numbers to month names
  mutate(year_over_year = (count_registered - lag(count_registered, 1)) / lag(count_registered,1)) %>%  # calculate year-over-year change
  ungroup()

# create new plots that show the monthly AND regional acquisition
plot_registrations_by_month_and_region <-
  registrations_by_month_and_region %>% 
  ggplot(aes(x = registration_month, y = count_registered)) +
  geom_col_interactive(aes(fill =  region,
                           data_id = month_name, 
                           tooltip = paste0(month_name, " of ", year,
                                            "\n",
                                            "\n",
                                            count_registered, " registrations",
                                            ifelse(is.na(year_over_year), 
                                                   "",
                                                   paste0("\n\n", 
                                                          scales::percent(year_over_year, accuracy = 0.01), 
                                                          " YOY change"))))) +
  geom_vline_interactive(xintercept = 12.5, linetype = "dotted", tooltip = "end of year") +
  theme_calc() +
  labs(x = "Month", y = "New Registrations", title = "Registration Growth by Region") +
  theme(legend.position = "none") +
  facet_wrap(~ region)

# show plot with highlight on month type when the user hovers
ggiraph(ggobj = plot_registrations_by_month_and_region,
        options = list(opts_hover_inv(css = "opacity:0.2;")))



```  
  
The seasonal pattern we saw above holds true for the **ROW** and **EMEA** regions: weaker growth winter and summer, stronger growth in spring and autumn. For **America**, we spot a couple notable exceptions: growth in current-year January that is on-par with the best months, and a very weak current-year May.   

We can see that the broad Rest of World (ROW) region is our biggest segment, by far. What if we plot **year-over-year registration growth** as a percentage for the different regions? (In this case, we can only examine months 13-21.)  

```{r create regions YOY acquisitions plot, warning = FALSE, message = FALSE}


# create new plots that show the monthly YOY change by region
plot_registrations_yoy_growth_by_region <-
  registrations_by_month_and_region %>% 
  filter(!is.na(year_over_year)) %>% 
  ggplot(aes(x = registration_month, y = year_over_year)) +
  geom_col_interactive(aes(fill =  region,
                           data_id = month_name, 
                           tooltip = paste0(month_name, " of ", year,
                                            "\n",
                                            "\n",
                                            count_registered, " registrations",
                                            ifelse(is.na(year_over_year), 
                                                   "",
                                                   paste0("\n\n", 
                                                          scales::percent(year_over_year, accuracy = 0.01), 
                                                          " YOY change"))))) +
  geom_vline_interactive(xintercept = 12.5, linetype = "dotted", tooltip = "end of year") +
  theme_calc() +
  labs(x = "Month", y = "YOY Change", title = "Year-over-year Growth Rate by Region") +
  theme(legend.position = "none") +
  scale_y_continuous(labels = scales::percent) +
  facet_wrap(~ region)

# show plot with highlight on month type when the user hovers
ggiraph(ggobj = plot_registrations_yoy_growth_by_region,
        options = list(opts_hover_inv(css = "opacity:0.2;")))


```  
  
  
We see an alarming visual here. While the **ROW** region was having a solid summer with outstanding year-over-year registration growth in July, **America** and **EMEA** saw several months of declining growth.  

Based on our data, we should expect **ROW** to be our growth market, based on its larger size and better trajectory. We may need to pay special attention to **America** and **EMEA** if we want to grow registrations in these segments. 

# Activity

## Global Activity

Let's take a look at user activity. How many users were active each month?  

```{r group and count activity,  warning = FALSE, message = FALSE}

activity_by_month <- 
  activity %>% 
  group_by(activity_month) %>% 
  count() %>% # get counts %>% 
  rename(count_active = n) %>% 
  mutate(year = ifelse(activity_month %in% 1:12, "Previous Year", "Current Year")) %>% # label the years
  mutate(month_name = ifelse(activity_month %in% 1:12, month.name[activity_month], month.name[activity_month - 12])) %>% 
  group_by(month_name) %>% # convert numbers to month names
  mutate(year_over_year = (count_active - lag(count_active, 1)) / lag(count_active,1)) %>%  # calculate year-over-year change
  ungroup()

# show html table
activity_by_month %>% 
  kable() %>% 
  kable_styling(c("striped", "hover")) %>% 
  scroll_box(height = "350px")

```  
\  

The active user count appears to be growing. We notice some lower points in the summer and winter seasons, which are also the seasons with lower registrations. Even the lowest point in the current year (August) has more active users than many months in the previous year.  

```{r plot activity by month, warning = FALSE, message = FALSE}

# ggplot of activity by month
plot_activity_by_month <-
  activity_by_month %>% 
  ggplot(aes(x = activity_month, y = count_active)) +
  geom_col_interactive(fill = "honeydew4", 
                       aes(data_id = month_name, 
                           tooltip = paste0(month_name, " of ", year,
                                            "\n",
                                            "\n",
                                            count_active, " active users",
                                            ifelse(is.na(year_over_year), 
                                                   "",
                                                   paste0("\n\n", 
                                                          scales::percent(year_over_year, accuracy = 0.01), 
                                                          " YOY change"))))) +
  geom_vline_interactive(xintercept = 12.5, linetype = "dotted", tooltip = "end of year") +
  theme_calc() +
  labs(x = "Month", y = "Count", title = "Active Users")

# show plot with highlight on month type when the user hovers
ggiraph(ggobj = plot_activity_by_month,
        options = list(opts_hover_inv(css = "opacity:0.2;")))


```  
  
## Active Users in America  

What percentage of active users are in the American region? Does it change over time?  

```{r percentage of activity in america, warning = FALSE, message = FALSE}

# count active users in America by month
# then join table of all active users by month and calculate proportion
activity_by_month_america <- 
  activity %>% 
  filter(region == "America") %>% 
  group_by(activity_month) %>% 
  count() %>% # get counts
  rename(count_active_america = n) %>% 
  left_join(activity_by_month, by = "activity_month") %>% 
  mutate(proportion_america = count_active_america / count_active) %>% 
  select(-"year_over_year") # drop irrelevant column

# point and line chart of percentage of active users in America
plot_activity_by_month_america <-
  activity_by_month_america %>% 
  ggplot(aes(x = activity_month, y = proportion_america)) +
  geom_point_interactive(aes(tooltip = paste0(month_name, " of ", year,
                                              "\n\n",
                                              scales::percent(proportion_america, accuracy = 0.01)))) +
  geom_line_interactive() +
  theme_calc() +
  labs(x = "Month", y = "Active Users in America", title = "Percentage of Active Users in America") +
  scale_y_continuous(labels = scales::percent) +
  theme(legend.position = "none")

# show plot with highlight on month type when the user hovers
ggiraph(ggobj = plot_activity_by_month_america,
        options = list(opts_hover_inv(css = "opacity:0.2;")))


```  
  
We can make two interesting observations from this chart.  
  
First, the share of Americans among active users seems to be declining in general. This matches with our earlier findings that **ROW** was the real growth market for the product.  

Second, the share of Americans among active users drops sharply in May of both years. We expect engagement with the product to be lower in summer, but this drop appears to be more dramatic in the American market than the other regions (or else the percentage share would remain level).  


# Retention

To analyze retention, we need to draw data from both the *registrations* and *activity* tables. This is because **not all users who registered became active**, so the list of users in the *activity* table is not a complete list. We'll take a look at **second-month retention**, which tells us what proportion of users were **active** in their second month after registering. We'll split users into cohorts according to the month in which they registered.  

```{r second month retention, warning = FALSE, message = FALSE}

# this is a tricky question...
# you must use both registrations.csv and activity.csv
# not all users who registered became active
# therefore, some users who registered are only represented in registrations.csv

monthly_cohort_retention <-
activity %>% 
  group_by(registration_month, activity_month) %>% 
  count() %>% 
  rename(count_active = n) %>% 
  inner_join(registrations_by_month, by = "registration_month") %>% 
  select(-year_over_year) %>%  # drop registration YOY
  rename(registration_month_name =  month_name, registration_year = year) %>% # rename for clarity
  group_by(registration_month) %>% 
  filter(activity_month == registration_month + 1) %>% 
  summarize(second_month_retention = count_active / count_registered,
            registration_month_name = registration_month_name,
            registration_year = registration_year)


# show html table
monthly_cohort_retention %>% 
  kable() %>% 
  kable_styling(c("striped", "hover")) %>% 
  scroll_box(height = "350px")

```
\   

Of the users who registered in **month 1**, `r scales::percent(monthly_cohort_retention$second_month_retention[1], accuracy = 0.01)` were active in their second month.  
Of the users who registered in **month 13**, `r scales::percent(monthly_cohort_retention$second_month_retention[13], accuracy = 0.01)` were active in their second month.  

Why is there a drop in second-month retention from last year's January cohort to this year's January cohort? The product likely attracted a different type of user when it was brand new in month 1. Users who registered when the product was brand new were probably **highly motivated by the product's unique value**. Perhaps that's why they were willing to try something completely new and unproven. But users who registered in month 13 might have had other reasons for trying the product: it was recommended to them by a friend, they saw an advertisement, they were required to use it for work, etc. Maybe they had a weaker motivation to stick around.   

We shouldn't expect retention rates to be the same among early adopters and users who register when the product is more mature. In fact, the graph below shows that the product's second-month retention rate **peaked with the month 2 cohort** and fell sharply after month 4.  

```{r plot second month retention by monthly cohort, message = FALSE, warning = FALSE}

#
plot_second_month_retention_by_registration_cohort <-
  monthly_cohort_retention %>% 
  ggplot(aes(x = registration_month, y = second_month_retention)) +
  geom_point_interactive(size = 2, aes(x = registration_month,
                                       y = second_month_retention,
                                       tooltip = paste0("Registered: ", registration_month_name, " of ", registration_year,
                                                        "\n\n",
                                                        scales::percent(second_month_retention, accuracy = 0.01), " retained in second month"))) +
  geom_line_interactive() +
  scale_y_continuous(labels = scales::percent) +
  theme_calc() +
  labs(x = "Month of Registration", 
       y = "Second Month Retention Rate", 
       title = "Second Month Retention Rate by Registration Cohort")

# show interactive plot
ggiraph(ggobj = plot_second_month_retention_by_registration_cohort)





```  
  
The lowest retention rates are among users who joined in December or July of the previous year. This follows a similar pattern we saw with acquisition and activity: the product has less appeal in winter and summer. Retaining these users might require an extra effort.  

# Conclusions  

Here are a few quick conclusions about the product:  

* **Registration growth may be slowing.** Registrations are already in negative year-over-year territory in the EMEA and America markets, and the past two months in the ROW market have been concerning. We should figure out why this is happening.  

* **Global activity looks healthy, for now.** The overall activity numbers are not bad. We see that American users are a shrinking proportion of the userbase and we can expect this trend to continue if ROW remains the big growth market. In the long run, we need to fix any problems with user acquisition if we want activity to keep growing.  

* **Retention varies by registration time.** The February and August cohorts have good second-month retention, but the May and June cohorts look awful. We need to study the different user experiences between high-retention cohorts and low-retention cohorts.  

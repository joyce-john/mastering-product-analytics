---
title: "Mastering Product Analytics"
author: "John Joyce"
date: "5/23/2021"
output:
  html_document:
    theme: "cosmo"
    code_folding: hide
---

# Introduction  

This is a sample analysis of key metrics for a software-as-a-service product. The usage data  is based off a real SaaS product; it has been subsampled and simplified for this task. We'll take a look at user **acquisition**, **activity**, and **retention**. We have 21 months of data for this product.   

```{r load libraries and data, warning=FALSE, message=FALSE}
# libraries
library(tidyverse)
library(ggthemes)
library(ggiraph)
library(scales)
library(kableExtra)

# load data from semicolon-delimited file
activity <- read_delim("activity.csv", delim = ";")
registrations <- read_delim("registrations.csv", delim = ";")

```  

# Acquisition  

Let's start out by examining registrations. We'll count the number of registrations in each month with the code below. We'll also calculate year-over-year percentage changes for the eligible months.  

```{r group and count registrations, warning=FALSE, message=FALSE}

# get registration counts grouped by month
registrations_by_month <- 
  registrations %>% 
  group_by(registration_month) %>% 
  count() %>% # get counts
  rename(count_registered = n) %>% 
  mutate(year = ifelse(registration_month %in% 1:12, "Previous Year", "Current Year")) %>% # label the years
  mutate(month_name = ifelse(registration_month %in% 1:12, month.name[registration_month], month.name[registration_month - 12])) %>% 
  group_by(month_name) %>% # convert numbers to month names
  mutate(year_over_year = (count_registered - lag(count_registered, 1)) / lag(count_registered,1)) %>%  # calculate year-over-year change
  ungroup()

# show html table
registrations_by_month %>% 
  kable() %>% 
  kable_styling(c("striped", "hover")) %>% 
  scroll_box(height = "350px")

```  
  
We'll plot this data below. We'll use a bar graph so that it's easy to compare values from one year against another - just hover over a column to highlight identical months. A dotted line separates the two years.  

```{r plot registrations by month, warning=FALSE, message=FALSE}

# ggplot of registrations by month
plot_registrations_by_month <-
  registrations_by_month %>% 
  ggplot(aes(x = registration_month, y = count_registered)) +
  geom_col_interactive(fill = "steelblue4",
                       aes(data_id = month_name, 
                           tooltip = paste0(month_name,
                                            "\n",
                                            "\n",
                                            count_registered, " registrations",
                                            ifelse(is.na(year_over_year), 
                                                   "",
                                                   paste0("\n\n", 
                                                          scales::percent(year_over_year, accuracy = 0.01), 
                                                          " YOY change"))))) +
  geom_vline_interactive(xintercept = 12.5, linetype = "dotted", tooltip = "end of year") +
  theme_calc() +
  labs(x = "Month", y = "New Registrations", title = "Registration Growth")

# show plot with highlight on month type when the user hovers
ggiraph(ggobj = plot_registrations_by_month,
        options = list(opts_hover_inv(css = "opacity:0.2;")))



```  
  
  
We notice some low points in January - Feburary and June - July (possibly including August). Our stronger months appear to be March - May and September - November. Based on the data we have, it seems that we acquire the most users in the **spring** and **autumn** seasons, and experience a slump in **winter** and **summer**.  

What are the acquisition trends in different regions?  

```{r create regions acquisition table and plot, warning = FALSE, message = FALSE}

# get registration counts grouped by month AND also by region
registrations_by_month_and_region <- 
  registrations %>% 
  group_by(registration_month, region) %>% 
  count() %>% # get counts
  rename(count_registered = n) %>% 
  mutate(year = ifelse(registration_month %in% 1:12, "Previous Year", "Current Year")) %>% # label the years
  mutate(month_name = ifelse(registration_month %in% 1:12, month.name[registration_month], month.name[registration_month - 12])) %>% 
  group_by(month_name, region) %>% # convert numbers to month names
  mutate(year_over_year = (count_registered - lag(count_registered, 1)) / lag(count_registered,1)) %>%  # calculate year-over-year change
  ungroup()

# create new plots that show the monthly AND regional acquisition
plot_registrations_by_month_and_region <-
  registrations_by_month_and_region %>% 
  ggplot(aes(x = registration_month, y = count_registered)) +
  geom_col_interactive(aes(fill =  region,
                           data_id = month_name, 
                           tooltip = paste0(month_name,
                                            "\n",
                                            "\n",
                                            count_registered, " registrations",
                                            ifelse(is.na(year_over_year), 
                                                   "",
                                                   paste0("\n\n", 
                                                          scales::percent(year_over_year, accuracy = 0.01), 
                                                          " YOY change"))))) +
  geom_vline_interactive(xintercept = 12.5, linetype = "dotted", tooltip = "end of year") +
  theme_calc() +
  labs(x = "Month", y = "New Registrations", title = "Registration Growth by Region") +
  theme(legend.position = "none") +
  facet_wrap(~ region)

# show plot with highlight on month type when the user hovers
ggiraph(ggobj = plot_registrations_by_month_and_region,
        options = list(opts_hover_inv(css = "opacity:0.2;")))



```  

```{r group and count activity,  warning = FALSE, message = FALSE}

activity_by_month <- 
  activity %>% 
  group_by(activity_month) %>% 
  count() %>% # get counts %>% 
  rename(count_active = n) %>% 
  mutate(year = ifelse(activity_month %in% 1:12, "Previous Year", "Current Year")) %>% # label the years
  mutate(month_name = ifelse(activity_month %in% 1:12, month.name[activity_month], month.name[activity_month - 12])) %>% 
  group_by(month_name) %>% # convert numbers to month names
  mutate(year_over_year = (count_active - lag(count_active, 1)) / lag(count_active,1)) %>%  # calculate year-over-year change
  ungroup()



```



```{r plot activity by month, warning = FALSE, message = FALSE}

# ggplot of activity by month
plot_activity_by_month <-
  activity_by_month %>% 
  ggplot(aes(x = activity_month, y = count_active)) +
  geom_col_interactive(fill = "honeydew4", 
                       aes(data_id = month_name, 
                           tooltip = paste0(month_name,
                                            "\n",
                                            "\n",
                                            count_active, " active users",
                                            ifelse(is.na(year_over_year), 
                                                   "",
                                                   paste0("\n\n", 
                                                          scales::percent(year_over_year, accuracy = 0.01), 
                                                          " YOY change"))))) +
  theme_calc() +
  labs(x = "Month", y = "Count", title = "Active User Growth")

# show plot with highlight on month type when the user hovers
ggiraph(ggobj = plot_activity_by_month,
        options = list(opts_hover_inv(css = "opacity:0.2;")))


```  
  

```{r second month retention, warning = FALSE, message = FALSE}

# this is a tricky question...
# you must use both registrations.csv and activity.csv
# because not all registered users in month 1 were active in month 1
# therefore, some users who registered are only represented in registrations.csv

monthly_cohort_retention <-
activity %>% 
  group_by(registration_month, activity_month) %>% 
  count() %>% 
  rename(count_active = n) %>% 
  inner_join(registrations_by_month, by = "registration_month") %>% 
  select(-year_over_year) %>%  # drop registration YOY
  rename(registration_month_name =  month_name, registration_year = year) %>% # rename for clarity
  group_by(registration_month) %>% 
  filter(activity_month == registration_month + 1) %>% 
  summarize(second_month_retention = count_active / count_registered,
            registration_month_name = registration_month_name,
            registration_year = registration_year)




```



```{r plot second month retention by monthly cohort, message = FALSE, warning = FALSE}

#
plot_second_month_retention_by_registration_cohort <-
  monthly_cohort_retention %>% 
  ggplot(aes(x = registration_month, y = second_month_retention)) +
  geom_point_interactive(size = 2, aes(x = registration_month,
                                       y = second_month_retention,
                                       tooltip = paste0("Registered: ", registration_month_name, " of ", registration_year,
                                                        "\n\n",
                                                        scales::percent(second_month_retention, accuracy = 0.01), " retained in second month"))) +
  geom_line_interactive() +
  theme_calc() +
  labs(x = "Month of Registration", 
       y = "Second Month Retention Rate", 
       title = "Second Month Retention Rate by Registration Cohort")

# show interactive plot
ggiraph(ggobj = plot_second_month_retention_by_registration_cohort)





```